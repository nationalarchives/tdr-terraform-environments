{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowManagedRuleToSendS3EventsToGuardDuty",
      "Effect": "Allow",
      "Action": [
        "events:PutRule"
      ],
      "Resource": [
        "arn:aws:events:eu-west-2:${account_id}:rule/DO-NOT-DELETE-AmazonGuardDutyMalwareProtectionS3*"
      ],
      "Condition": {
        "StringEquals": {
          "events:ManagedBy": "malware-protection-plan.guardduty.amazonaws.com"
        },
        "ForAllValues:StringEquals": {
          "events:source": "aws.s3",
          "events:detail-type": [
            "Object Created",
            "AWS API Call via CloudTrail"
          ]
        },
        "Null": {
          "events:source": "false",
          "events:detail-type": "false"
        }
      }
    },
    {
      "Sid": "AllowUpdateTargetAndDeleteManagedRule",
      "Effect": "Allow",
      "Action": [
        "events:DeleteRule",
        "events:PutTargets",
        "events:RemoveTargets"
      ],
      "Resource": [
        "arn:aws:events:eu-west-2:${account_id}:rule/DO-NOT-DELETE-AmazonGuardDutyMalwareProtectionS3*"
      ],
      "Condition": {
        "StringEquals": {
          "events:ManagedBy": "malware-protection-plan.guardduty.amazonaws.com"
        }
      }
    },
    {
      "Sid": "AllowGuardDutyToMonitorEventBridgeManagedRule",
      "Effect": "Allow",
      "Action": [
        "events:DescribeRule",
        "events:ListTargetsByRule"
      ],
      "Resource": [
        "arn:aws:events:eu-west-2:${account_id}:rule/DO-NOT-DELETE-AmazonGuardDutyMalwareProtectionS3*"
      ]
    },
    {
      "Sid": "AllowEnableS3EventBridgeEvents",
      "Effect": "Allow",
      "Action": [
        "s3:PutBucketNotification",
        "s3:GetBucketNotification"
      ],
      "Resource": ${jsonencode(enabled_bucket_arns)},
      "Condition": {
        "StringEquals": {
          "aws:ResourceAccount": "${account_id}"
        }
      }
    },
    {
      "Sid": "AllowPostScanTag",
      "Effect": "Allow",
      "Action": [
        "s3:GetObjectTagging",
        "s3:GetObjectVersionTagging",
        "s3:PutObjectTagging",
        "s3:PutObjectVersionTagging"
      ],
      "Resource": ${jsonencode(enabled_bucket_object_arns)},
      "Condition": {
        "StringEquals": {
          "aws:ResourceAccount": "${account_id}"
        }
      }
    },
    {
      "Sid": "AllowPutValidationObject",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": ${jsonencode(malware_validation_objects)},
      "Condition": {
        "StringEquals": {
          "aws:ResourceAccount": "${account_id}"
        }
      }
    },
    {
      "Sid": "AllowCheckBucketOwnership",
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": ${jsonencode(enabled_bucket_arns)},
      "Condition": {
        "StringEquals": {
          "aws:ResourceAccount": "${account_id}"
        }
      }
    },
    {
      "Sid": "AllowMalwareScan",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion"
      ],
      "Resource": ${jsonencode(enabled_bucket_object_arns)},
      "Condition": {
        "StringEquals": {
          "aws:ResourceAccount": "${account_id}"
        }
      }
    },
    {
      "Sid": "AllowDecryptForMalwareScan",
      "Effect": "Allow",
      "Action": [
        "kms:GenerateDataKey",
        "kms:Decrypt"
      ],
      "Resource": ${jsonencode(bucket_encryption_key_arns)},
      "Condition": {
        "StringEquals": {
          "kms:CallerAccount": "${account_id}",
          "kms:ViaService": "s3.eu-west-2.amazonaws.com"
        },
        "StringLike": {
          "kms:EncryptionContext:aws:s3:arn": ${jsonencode(enabled_bucket_arns)}
        }
      }
    }
  ]
}
